<h1>cperl status</h1>

<p><a href="https://travis-ci.org/perl11/cperl"><img src="https://travis-ci.org/perl11/cperl.svg?branch=master" alt="Build Status" /></a> <a href="https://scan.coverity.com/projects/perl11-cperl"><img src="https://scan.coverity.com/projects/6933/badge.svg" alt="Coverity Status" /></a> <a href="perl11.org/cperl/STATUS.html">perl11.org/cperl/STATUS.html</a></p>

<p>The name <strong>cperl</strong> stands for <strong>a perl with classes, types, compiler
support, continuation of perl5 development or just a company-friendly
perl</strong>, but currently it's only a better variant with types and signatures,
and without classes.</p>

<p>cperl started Feb. 2015 when <code>:const</code> was added, parrot was killed and
it became clear that optimizing for fun is better than waiting for
someone else to allow it.</p>

<p>Currently it is about 1.5x faster than perl5.22 overall, >2x faster
then 5.14 and uses the least amount of memory measured since 5.6,
i.e. less than 5.10 and 5.6.2, which were the previous leaders. While
perl5.22 uses the most memory yet measured. cperl 5.24 is about 2x faster
than 5.22.</p>

<p>But not all of the wanted features are merged.  The plan is to support
most perl5-compatible perl6 features (<em>"do not break CPAN"</em>), improve
performance and memory usage, re-establish compiler (<code>B::C</code>) support,
re-establish perl5 core development which essentially stopped 2002,
use perl6-like development policies, and better security fixes and
maintenance than the upstream p5p perl5. See <a href="perlcperl.html">README.cperl</a>.</p>

<p>Tested and developed on linux and darwin 64bit. darwin 32bit fails
on two unrelated core tests (issignaling setpayloadsig + chmod linked in).
Windows is smoked with MSVC 10 and 12 for 32 and 64bit.</p>

<p>The current release <a href="https://github.com/perl11/cperl/releases/">5.22.3c</a>
is stable. cperl-5.24.0 is almost done. See <a href="https://github.com/perl11/cperl/releases/">RC5</a> and <a href="perlcdelta.html">perlcdelta</a>.</p>

<p>All tests pass. CPAN works.</p>

<p>For 5.22.1c some fixes in my <code>rurban/distroprefs</code> repo for
<code>Sub::Install</code>, <code>Variable::Magic</code>, ...  are needed.</p>

<p>For 5.24.0c with some modernized core modules some signatures are
pretty strictly typed to catch wrong usages and enforce better code.
See the <code>Test::More::skip()</code> <a href="https://github.com/perl11/cperl/issues/153#issuecomment-224515895">FAQ</a> or below.
Patches are needed for <code>Module::Build</code>, <code>IO::Socket::SSL</code> and <code>Net::SSLeay</code>.
<code>bigint</code>, <code>bignum</code> and <code>bigrat</code> are now also stricly typed, you shouldn't mess with
sloppy types there neither. See below for Known Problems.</p>

<p>This is still much less than with a typical major perl5 release, and
the patches are all provided in my
<a href="https://github.com/rurban/distroprefs/">rurban/distroprefs</a>, so the
upgrade is seemless.  E.g. Test2 (the new Test::Simple) broke >15
modules without any patches.</p>

<p>cperl-5.24.0c has <a href="perldelta.html#Known-Problems-fixed-elsewhere">about 24 fixes</a>,
for problems which are not fixed in perl-5.24.1.</p>

<p><img src="cperl-m0.png" alt="Memory usage: perl -e0" /></p>

<p><img src="cperl-p0.png" alt="Memory usage: with Config_heavy" /></p>

<p><img src="cperl-p1.png" alt="Memory usage with unicode s///i" /></p>

<h1>In the stable master branch are the following major features</h1>

<ul>
<li>coretypes (Int, UInt, Num, Str. lowercase native types accepted)</li>
<li>types in signatures as designed and also as attribute</li>
<li>function return types declarations as attribute</li>
<li>many more builtin function attributes</li>
<li>shaped arrays with compile-time checks and optims</li>
<li>static loop optims</li>
<li>fast arithmetic overflow</li>
<li>convert static method to subs</li>
<li>Config as XS</li>
<li>strict, attributes, DynaLoader, XSLoader as builtin packages, rewritten in C.
Security fixes for DynaLoader</li>
<li>changed default hash function to the fastest FNV1A <em>(as in the stableperl fork)</em></li>
<li>changed the hash collision strategy from randomize to the usual move-to-front</li>
<li>changed the default hash fill rate from 100% to 90%</li>
<li>seperate XS and PP XS calls dynamically with a new enterxssub op</li>
<li>-DI and -Dk</li>
<li>add some unicode ops</li>
<li>improved build system (make -s, faster, CC vs LD confusion)</li>
<li>hash keys keep the tainted info. see <a href="http://perldoc.perl.org/perlsec.html#Taint-mode">perlsec</a></li>
<li>fix ops using lexical <code>$_</code></li>
<li>readonly packages can be cloned with threads</li>
<li>security and overlarge data fixes for Storable</li>
<li>include B-C, Cpanel::JSON::XS, YAML::XS, Devel::NYTProf, Term::ReadKey</li>
<li>improved redefined warnings</li>
<li>cperl specific toolchain modules, with support for cperl-only module
versions with a 'c' suffix, and 10x faster JSON and YAML usage. (esp. with cpan).</li>
<li>many typed and modernized core modules, where signatures and types make
sense and cause not much trouble.</li>
<li>some security fixes for Unicode confusables, but more are needed (use strict 'names').</li>
<li>handle method calls on protected stashes</li>
</ul>

<p>Most of them only would have a chance to be merged upstream if a p5p
committer would have written it.</p>

<p>But some features revert decisions p5p already made. See
<a href="perlcperl.html">README.cperl</a>.  When in doubt I went with the
decisions and policies perl5 made before 2001, before p5p went
downwards. It is very unlikely that p5p will revert their own design
mistakes. It never happened so far.</p>

<h1>Installation</h1>

<h2>From source</h2>

<p>Download the latest .tar.gz or .tar.bz2 from <a href="https://github.com/perl11/cperl/releases/">github.com/perl11/cperl/releases/</a></p>

<pre><code>tar xfz cperl-5.VER
cd cperl-5.VER
./Configure -sde
make -s -j4 test
sudo make install
</code></pre>

<h2>rpm</h2>

<p>add this file to <code>/etc/yum.repos.d/perl11.repo</code>, with either <code>el6</code> or <code>el7</code>.
<code>el6</code> for Centos6 and older Fedora and RHEL, <code>el7</code> for Centos7 and newer variants.</p>

<pre><code>[perl11]
name=perl11
baseurl=http://perl11.org/rpm/el7/$basearch
enabled=1
gpgkey==http://perl11.org/rpm/RPM-GPG-KEY-rurban
gpgcheck=1
</code></pre>

<p>run as root: <code>yum update; yum install cperl</code></p>

<h2>debian</h2>

<p>add this file to <code>/etc/apt/sources.list.d/perl11.list</code></p>

<pre><code>deb http://perl11.org/deb/ sid main
</code></pre>

<p>run as root:</p>

<pre><code>apt update
wget http://perl11.org/deb/rurban.gpg.key
apt-key add rurban.gpg.key
apt install cperl
</code></pre>

<h2>osx</h2>

<p>download the pkg installer from <a href="http://perl11.org/osx/">http://perl11.org/osx/</a></p>

<h2>windows</h2>

<p>download the self-extracting zip from <a href="http://perl11.org/win/">http://perl11.org/win/</a>
and install it into drive and directory <code>C:\cperl</code>.</p>

<h1>Known bugs</h1>

<p>See the github issues: <a href="https://github.com/perl11/cperl/issues">github.com/perl11/cperl/issues</a></p>

<p>The perl debugger is unstable with signatures and tailcalls (AUTOLOAD).</p>

<p>The following CPAN modules have no patches for 5.24.0c yet:</p>

<ul>
<li>autovivification (mderef rpeep changes)</li>
<li>TryCatch</li>
<li>Catalyst::Runtime</li>
</ul>

<p>Time::Tiny, Date::Tiny, DateTime::Tiny feature DateTime::locale broken since 5.22.
unrelated to cperl, -f force install.</p>

<h1>FAQ</h1>

<h2>Test::More::skip errors</h2>

<p><strong>skip</strong> has the historical problem of mixed up arguments of <code>$why</code>
and <code>$count</code>, so those arguments are now stricter typed to catch all
wrong arguments. At compile-time.</p>

<p>When you use one or two args for <code>Test::More::skip()</code>, they need to
properly typed.</p>

<p>I.e.</p>

<p><strong>Mandatory:</strong></p>

<pre><code>skip $why, 1               =&gt; skip "$why", 1

plan tests =&gt; 1;
SKIP: { skip }             =&gt; SKIP: { skip "", 1; }
</code></pre>

<p><strong>Recommended:</strong></p>

<pre><code>skip "why", scalar(@skips) =&gt; skip "why", int(@skips)

skip "why", 2*$skips       =&gt; skip "why", int(2*$skips)
</code></pre>

<p><strong>Rationale</strong>:</p>

<p><code>skip()</code> is a special case that the two args are very often mixed
up. This error had previously to be detected at run-time with a
fragile \d regex check. And in most cases this problem was never
fixed, e.g. in <code>Module::Build</code>.</p>

<p>Only with checking for strict types I could detect and fix all of the
wrong usages, get rid of the unneeded run-time check, the code is
better, all errors are detected at compile time, and not covered at
run-time and with the new strict types the code is much more readable,
what is the <code>str $why</code> and what the <code>UInt $count</code> argument.</p>

<p><strong>When the <code>$count</code> can be optional</strong></p>

<p>The Test::More docs state the following:
<em>It's important that $how_many accurately reflects the number of tests
in the SKIP block so the # of tests run will match up with your plan.
If your plan is no_plan $how_many is optional and will default to 1.</em></p>

<p>I.e. Only with plan tests => 'no_plan' a bare skip is allowed.</p>

<p><code>$count</code> can never be a NV, thus <code>:Numeric</code> (which would allow
<code>2*$skip</code>) is wrong. It needs to be <code>:UInt</code>. The used range op
(<code>pp_flip</code>) would die at run-time with a overflowed number. <code>die
"Range iterator outside integer range"</code>. <code>$count := -1</code> will lead to
test timeouts.</p>

<p>Note that cperl doesn't yet check <code>UInt</code> types at run-time for
negative values. This might change in later versions with the <code>use
types</code> pragma.  For now the <code>$count</code> type is relaxed to <code>:Numeric</code> to
permit simple arithmetic.</p>

<p><code>scalar(@array)</code> for array or hash length is also bad code, it needs
to be replaced with <code>int(@array)</code>.  Such a length can never be a NV or
PV, it is always a UInt. Using <code>int()</code> is clearer and better, at least
for cperl.</p>

<p>This is also the answer to the question why <code>scalar(@array)</code> is
considered bad, and why counts and lengths cannot overflow.</p>

<h1>Branch overview</h1>

<h2>Older bugfixes for perl5 upstream</h2>

<ul>
<li><a href="http://github.com/perl11/cperl/commits/merge-upstream">merge-upstream</a></li>
</ul>

<p>This could have been easily taken up upstream, was already perlbug'ed and
published, and did not violate any of the p5p commit policies and
previous decisions.  From those 47 patches 2 were taken, some
were rejected and 2 were butchered, i.e. rewritten in a worse way.</p>

<h2>Almost ready branches, only minor tests are failing</h2>

<p>Those branches could have theoretically been merged upstream, but the chances
are limited. So they are based on master.</p>

<ul>
<li><p><a href="https://github.com/perl11/cperl/issues/8">bugfix/gh8-cowrefcnt</a></p>

<p><a href="http://github.com/perl11/cperl/commits/bugfix/gh8-cowrefcnt">code</a></p>

<p>works for the compiler, but does not do COW yet, i.e. slower for
uncompiled perls, faster for compiled.</p></li>
<li><p><a href="http://github.com/perl11/cperl/commits/feature/CM-367-cperl-warnings-xs-carp">feature/CM-367-cperl-warnings-xs-carp</a></p></li>
<li><a href="http://github.com/perl11/cperl/commits/feature/CM-367-cperl-carp-builtin">feature/CM-367-cperl-carp-builtin</a></li>
<li><p><a href="https://github.com/perl11/cperl/issues/9">feature/gh9-warnings-xs</a></p>

<p><a href="http://github.com/perl11/cperl/commits/feature/gh9-warnings-xs">code</a></p>

<p>much faster and much less memory, but 3 minor scope test fails.</p></li>
<li><p><a href="https://github.com/perl11/cperl/issues/6">feature/gh6-no-miniperl</a></p>

<p><a href="http://github.com/perl11/cperl/commits/feature/gh6-no-miniperl">code</a></p>

<p>Need to fix some Makefile deps and break cross-references</p></li>
<li><p><a href="http://github.com/perl11/cperl/commits/feature/CM-626-cperl-use-dots">feature/CM-626-cperl-use-dots</a></p>

<p>works, but unsure if good enough. <code>.</code> instead of <code>-&gt;</code> works only for
a few method calls and clashes with string concat. A disruptive
design decision, which probably cannot be backported. Chip has a
perl6-like patch which changes <code>.</code> to <code>~</code> for string concat also,
but this doesn't accept valid perl5 syntax then. A blocker.</p></li>
<li><p><a href="https://github.com/perl11/cperl/issues/102">feature/gh102-smallhash</a></p>

<p><a href="http://github.com/perl11/cperl/commits/feature/gh102-smallhash">code</a></p>

<p>optimize the speed for small hashes.</p></li>
<li><p><a href="https://github.com/perl11/cperl/issues/176">feature/gh176-unexec</a></p>

<p><a href="http://github.com/perl11/cperl/commits/feature/gh176-unexec">code</a></p>

<p>compile/dump to native code via emacs unexec, on most platforms.</p></li>
</ul>

<h2>A bit more work is needed for</h2>

<p>These are major new features, and have no chance to be merged upstream.
They also revert some wrong decisions p5p already made.</p>

<ul>
<li><p><a href="https://github.com/perl11/cperl/issues/14">feature/gh14-native-types</a></p>

<p><a href="http://github.com/perl11/cperl/commits/feature/gh14-native-types">code</a></p>

<p>int, uint, num, str. unboxed data on the stack and pads. some minor
compiler fixes needed, esp. for typed pads. boxed or unboxed, that's
the question.</p></li>
<li><p><a href="https://github.com/perl11/cperl/issues/23">feature/gh23-inline-subs</a></p>

<p><a href="http://github.com/perl11/cperl/commits/feature/gh23-inline-subs">code</a></p>

<p>some compiler fixes needed</p></li>
<li><p><a href="http://github.com/perl11/cperl/commits/feature/CM-712-cperl-types-proto">feature/CM-712-cperl-types-proto</a></p>

<p>constant fold everything, not only with empty <code>()</code> protos</p></li>
<li><p><a href="https://github.com/perl11/cperl/issues/24">feature/gh24-new-hash-table</a></p>

<p><a href="http://github.com/perl11/cperl/commits/feature/gh24-new-hash-table">code</a></p>

<p>lots of small attempts, but still too hairy. needs a complete hash table rewrite.</p></li>
<li><p><a href="https://github.com/perl11/cperl/issues/16">feature/gh16-multi</a></p>

<p><a href="http://github.com/perl11/cperl/commits/feature/gh16-multi">code</a></p>

<p>class, method and multi keywords but no dispatch, subtyping and type checks yet.
in work.</p></li>
</ul>

<h2>Soon</h2>

<ul>
<li><p>user facing classes, multiple dispatch (fast for binary, slow for mega)</p></li>
<li><p>builtin macros</p></li>
<li><p>builtin ffi</p></li>
</ul>

<p>2016-07-19 rurban</p>
